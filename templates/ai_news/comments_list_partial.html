{% set page_size = 5 %}
{% set total_comments = messages|length %}

<div id="comments-container-{{ news_id }}" class="space-y-4">
  {% for msg in messages %}
    <div class="chat-message flex items-start gap-3 mb-4 {% if msg.reply_to_name %}bg-blue-50 border-l-4 border-blue-200 pl-2{% else %}bg-emerald-100{% endif %}" 
         id="msg-{{ msg._id }}"
         data-depth="{{ msg.depth }}"
         hx-swap-oob="true">
      <img src="{{ msg.author.avatar or '/static/img/avatar-default.png' }}" class="comment-avatar">
      <div class="bubble flex-1">
        <div class="flex items-center gap-2 mb-1">
          <span class="comment-author">{{ msg.author.name }}</span>
          <span class="text-xs text-gray-500">{{ msg.created_at.strftime('%d/%m/%Y %H:%M') if msg.created_at else '' }}</span>
        </div>
        {% if msg.reply_to_name %}
          <div class="text-xs text-blue-600 mb-1 flex items-center gap-1">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
            </svg>
            <span>in risposta a: {{ msg.reply_to_name }}</span>
          </div>
        {% endif %}
        <div class="comment-content">
          {% set content = msg.content %}
          {% if msg.mentions %}
            {% for mention_id in msg.mentions %}
              {# Trova il nome utente associato alla menzione #}
              {% set mention_name = None %}
              {% for u in users if u.id == mention_id %}{% set mention_name = u.name %}{% endfor %}
              {% if mention_name %}
                {% set is_mentioned = user and (mention_id == user._id|string) %}
                {% set is_author = user and (msg.author_id == user._id|string) %}
                {% set mention_class = 'mention' %}
                {% if is_mentioned or is_author %}
                  {% set mention_class = mention_class + ' mention-highlight' %}
                {% endif %}
                {% set mention_text = '@[' ~ mention_name ~ '](' ~ mention_id ~ ')' %}
                {% set mention_html = '<a href="#" class="' ~ mention_class ~ '">@' ~ mention_name ~ '</a>' %}
                {% set content = content.replace(mention_text, mention_html) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ content | safe }}
        </div>
        <div class="comment-actions mt-2 flex gap-2">
          <button class="reply-button flex items-center space-x-1 text-gray-500 hover:text-blue-600 text-sm"
                  data-comment-id="{{ msg._id }}"
                  data-news-id="{{ news_id }}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
            </svg>
            <span>Rispondi</span>
          </button>
          {% if msg.replies_count > 0 %}
          <button class="replies-toggle flex items-center space-x-1 text-gray-500 hover:text-blue-600 text-sm"
                  id="toggle-replies-{{ msg._id }}"
                  data-comment-id="{{ msg._id }}"
                  data-news-id="{{ news_id }}">
            <svg class="w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            <span>Mostra risposte ({{ msg.replies_count }})</span>
          </button>
          {% endif %}
          {% if user and (user.role == 'admin' or user._id == msg.author._id) %}
          <button class="delete-comment flex items-center space-x-1 text-gray-500 hover:text-red-600 text-sm"
                  data-comment-id="{{ msg._id }}"
                  data-news-id="{{ news_id }}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            <span>Elimina</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Container per il form di risposta sotto ogni commento -->
    <div id="reply-form-container-{{ msg._id }}"></div>
    <!-- Container per le risposte al commento -->
    {% if msg.replies_count > 0 %}
    <div id="replies-container-{{ msg._id }}" class="hidden ml-8 space-y-4 border-l-2 border-blue-200"></div>
    {% endif %}
  {% endfor %}
</div>
<!-- Indicatore di digitazione -->
<div id="typing-indicator-{{ news_id }}" class="ml-4"></div>

{% if total_comments == page_size %}
<div class="text-center py-4" id="load-more-{{ news_id }}" hx-swap-oob="true">
  <button 
    class="load-more-btn px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
    hx-get="/api/ai-news/{{ news_id }}/comments?page=2"
    hx-target="#comments-container-{{ news_id }}"
    hx-swap="beforeend"
    hx-trigger="click"
    hx-indicator="#loading-indicator-{{ news_id }}"
    data-page="2"
    _="on htmx:afterRequest 
       if event.detail.successful
         set my dataset.page to (parseInt(my dataset.page) + 1)
         set my @hx-get to '/api/ai-news/{{ news_id }}/comments?page=' + my dataset.page">
    <span class="flex items-center gap-2">
      <span>Carica altri commenti</span>
      <svg class="w-4 h-4 animate-spin hidden" id="loading-indicator-{{ news_id }}" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </span>
  </button>
</div>
{% endif %}

<script>
    window.currentUserId = "{{ user._id }}";
    window.currentUserName = "{{ user.name }}";
</script> 